<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 智慧搜尋播放器 - Apple風格</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            --card-bg-glass: rgba(255, 255, 255, 0.65);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #d1d5db;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07);
            --modal-bg: rgba(249, 250, 251, 0.95);
            --accent-color: #3b82f6;
        }

        body.theme-dark {
            --bg-gradient: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            --card-bg-glass: rgba(31, 41, 55, 0.65);
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --modal-bg: rgba(23, 31, 42, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 16px;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 32px; }
        .title { font-size: 2.5rem; font-weight: bold; margin-bottom: 8px; }
        .subtitle { color: var(--text-secondary); font-size: 1rem; }
        
        .search-card {
            background: var(--card-bg-glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color); border-radius: 16px; padding: 24px;
            box-shadow: var(--shadow); margin-bottom: 32px; position: relative;
        }
        .search-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .search-title { font-size: 1.25rem; font-weight: 600; }
        .theme-switcher { display: flex; gap: 4px; }
        .theme-btn { background: none; border: 1px solid var(--border-color); cursor: pointer; font-size: 0.9rem; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .theme-btn:hover { background-color: rgba(128, 128, 128, 0.2); }
        .search-form { display: flex; gap: 12px; }
        .search-input { flex: 1; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; outline: none; transition: all 0.2s; background-color: var(--card-bg-glass); color: var(--text-primary); }
        .search-input:focus { border-color: var(--accent-color); }
        .search-btn { color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; background: var(--accent-color); }
        .search-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        #searchHistory {
            display: none; position: absolute; top: 100%; left: 24px; right: 24px;
            background-color: var(--modal-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-top: none;
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
            box-shadow: var(--shadow); z-index: 100; max-height: 250px; overflow-y: auto;
        }
        .history-item { padding: 12px 16px; cursor: pointer; transition: background-color 0.2s; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); }
        .history-item:hover { background-color: rgba(128, 128, 128, 0.1); color: var(--text-primary); }
        #clearHistoryBtn { padding: 12px 16px; cursor: pointer; color: var(--accent-color); font-weight: 500; text-align: center; transition: background-color 0.2s; }
        #clearHistoryBtn:hover { background-color: rgba(128, 128, 128, 0.1); }

        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 32px; }
        .player-card, .results-card { background: var(--card-bg-glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); }
        .player-title, .results-title { font-size: 1.25rem; font-weight: 600; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        #backToSearchBtn { background: none; border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px 10px; border-radius: 6px; cursor: pointer; display: none; }
        .video-title { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 16px; min-height: 2.5em; transition: color 0.3s; }
        
        .player-wrapper { text-align: center; cursor: pointer; }
        .player-container { position: relative; background: #000; border-radius: 12px; overflow: hidden; margin: 0 auto; transition: all 0.4s ease-in-out; width: 100%; max-width: 100%; aspect-ratio: 16/9; }
        .player-container.is-short { max-width: 340px; aspect-ratio: 9/16; }
        .player-area, #youtube-player { width: 100%; height: 100%; }
        .placeholder { color: var(--text-secondary); text-align: center; padding: 32px; }

        .player-controls { display: none; justify-content: center; gap: 12px; margin-top: 16px; transition: opacity 0.3s; }
        .player-control-btn { background-color: var(--card-bg-glass); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .player-control-btn:hover { border-color: var(--accent-color); background-color: rgba(128,128,128,0.1); }

        .results-count { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 16px; }
        .results-list { max-height: 520px; overflow-y: auto; padding-right: 8px; }
        .result-item { display: flex; gap: 16px; padding: 12px; border-radius: 12px; border: 1px solid transparent; margin-bottom: 16px; cursor: pointer; transition: all 0.2s ease; background-color: var(--card-bg-glass); }
        .result-item:hover { transform: translateY(-4px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-color: var(--border-color); }
        .result-thumb { width: 120px; height: 90px; background-color: var(--border-color); border-radius: 8px; flex-shrink: 0; object-fit: cover; }
        .result-thumb.channel { border-radius: 50%; }
        .result-info { flex: 1; min-width: 0; display: flex; flex-direction: column; }
        .result-title { font-size: 1rem; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
        .result-channel { color: var(--text-secondary); font-size: 0.8rem; margin-top: auto; }
        .result-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; color: white; margin-bottom: 8px; align-self: flex-start; }
        .badge-video { background-color: #ef4444; } .badge-playlist { background-color: #3b82f6; } .badge-channel { background-color: #16a34a; }
        
        #confirmationModal { /* ... 樣式不變 ... */ }

        @media (max-width: 768px) { /* ... 樣式不變 ... */ }
    </style>
</head>
<body class="theme-light">
    <div class="container">
        <header class="header">
            <h1 class="title">YouTube 智慧搜尋播放器</h1>
            <p class="subtitle">即時播放・智慧體驗</p>
        </header>

        <section class="search-card">
            <div class="search-header">
                <h2 class="search-title">🔍 搜尋內容</h2>
                <div class="theme-switcher"><!-- ... --></div>
            </div>
            <div class="search-form">
                <input type="text" id="searchInput" class="search-input" placeholder="輸入關鍵字..." autocomplete="off">
                <button id="searchBtn" class="search-btn">搜尋</button>
            </div>
            <div id="searchHistory"></div>
        </section>

        <main class="main-grid" id="mainGrid">
            <section class="player-card" id="playerCard">
                <h2 class="player-title">影片播放器</h2>
                <div class="video-title" id="videoTitle">點擊搜尋結果中的影片以立即播放</div>
                <div class="player-wrapper" id="playerWrapper" title="快速按兩下可全螢幕播放">
                    <div class="player-container" id="playerContainer">
                        <div class="player-area">
                            <div id="placeholder" class="placeholder">播放器區域</div>
                            <div id="youtube-player" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="player-controls" id="playerControls">
                        <button id="copyUrlBtn" class="player-control-btn">🔗 複製網址</button>
                    </div>
                </div>
            </section>

            <section class="results-card" id="resultsCard"><!-- ... --></section>
        </main>
    </div>

    <div id="confirmationModal"><!-- ... --></div>
    <button id="scrollToTopBtn" title="返回頂部">⬆️</button>

    <script>
        // ⚠️⚠️⚠️ [極度重要] 安全警告 ⚠️⚠️⚠️
        // 在任何公開的專案中，您「絕對不能」將 API 金鑰直接寫在前端程式碼中。
        // 這會讓您的金鑰被盜用，導致 API 配額耗盡或產生費用。
        // 正確做法是：建立一個後端伺服器，由您的後端去呼叫 YouTube API。
        const YOUTUBE_API_KEY = 'AIzaSyDjypfpOwmfNGhF61lXdkZ-DtybwNv0aTg';
        
        let player;
        let currentVideoId = null;
        let lastSearchResults = { html: '', count: '', title: '' };

        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(localStorage.getItem('youtubePlayerTheme') || 'light');
            loadYouTubeAPI();
            setupEventListeners();
            loadSearchHistory();
        });

        function setupEventListeners() {
            $('#lightThemeBtn').addEventListener('click', () => applyTheme('light'));
            $('#darkThemeBtn').addEventListener('click', () => applyTheme('dark'));
            $('#searchBtn').addEventListener('click', () => searchContent());
            $('#searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); searchContent(); } });
            
            $('#searchInput').addEventListener('focus', showSearchHistory);
            document.addEventListener('click', (e) => {
                if (!$('.search-card').contains(e.target)) {
                    $('#searchHistory').style.display = 'none';
                }
            });

            // 播放器事件
            $('#playerWrapper').addEventListener('dblclick', toggleFullScreen);
            $('#copyUrlBtn').addEventListener('click', copyVideoUrl);

            $('#modalCloseBtn').addEventListener('click', hideConfirmationModal);
            // ... 其他事件監聽
        }

        // ... 省略部分不變的函式: applyTheme, loadYouTubeAPI, showLoadingSkeletons, apiFetch ...

        async function searchContent() {
            // ... 搜尋邏輯不變
        }
        
        function displayResults(items, title) {
            $('#resultsTitle').textContent = title;
            if (items.length === 0) {
                $('#resultsList').innerHTML = '<div class="empty-state">沒有找到相關內容</div>';
                $('#resultsCount').textContent = '';
                return;
            }
            $('#resultsCount').textContent = `找到 ${items.length} 個結果`;
            $('#resultsList').innerHTML = items.map(item => {
                const { id, snippet } = item;
                const thumbnailUrl = snippet.thumbnails.medium?.url || '';
                const escapedTitle = snippet.title.replace(/'/g, "\\'").replace(/"/g, """);
                let onclickAction = '';

                switch (id.kind) {
                    case 'youtube#video':
                        // ***核心改動：影片直接播放***
                        onclickAction = `playItem('${id.videoId}', '${escapedTitle}', 'video')`;
                        return createResultItem('video', onclickAction, thumbnailUrl, snippet.title, snippet.channelTitle);
                    case 'youtube#playlist':
                        onclickAction = `showConfirmationModal('${id.playlistId}', 'playlist')`;
                        return createResultItem('playlist', onclickAction, thumbnailUrl, snippet.title, `由 ${snippet.channelTitle} 建立`);
                    case 'youtube#channel':
                        onclickAction = `showConfirmationModal('${id.channelId}', 'channel')`;
                        return createResultItem('channel', onclickAction, thumbnailUrl, snippet.title, snippet.description || '點擊查看頻道影片', true);
                }
            }).join('');
        }

        // ... createResultItem, showConfirmationModal 等函式保持不變

        // --- 搜尋歷史紀錄 ---
        function getSearchHistory() { return JSON.parse(localStorage.getItem('youtubeSearchHistory') || '[]'); }

        function saveSearchHistory(query) {
            let history = getSearchHistory().filter(item => item !== query);
            history.unshift(query);
            if (history.length > 5) history = history.slice(0, 5);
            localStorage.setItem('youtubeSearchHistory', JSON.stringify(history));
            loadSearchHistory();
        }

        function loadSearchHistory() {
            const history = getSearchHistory();
            const historyContainer = $('#searchHistory');
            let historyHtml = history.map(item => `<div class="history-item">${item}</div>`).join('');
            if(history.length > 0) {
                historyHtml += `<div id="clearHistoryBtn">清除歷史紀錄</div>`;
            }
            historyContainer.innerHTML = historyHtml;
            
            $$('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    $('#searchInput').value = item.textContent;
                    searchContent();
                });
            });
            
            if ($('#clearHistoryBtn')) {
                $('#clearHistoryBtn').addEventListener('click', clearSearchHistory);
            }
        }
        
        function clearSearchHistory() {
            localStorage.removeItem('youtubeSearchHistory');
            loadSearchHistory();
            $('#searchHistory').style.display = 'none';
        }

        function showSearchHistory() {
            if (getSearchHistory().length > 0) {
                $('#searchHistory').style.display = 'block';
            }
        }

        // --- 播放器相關 ---
        function playItem(id, title, type) {
            currentVideoId = (type === 'video') ? id : null;
            $('#videoTitle').textContent = title;
            $('#videoTitle').style.color = 'var(--text-primary)';
            $('#placeholder').style.display = 'none';
            $('#youtube-player').style.display = 'block';
            $('#playerControls').style.display = 'flex';
            
            $('#playerCard').scrollIntoView({ behavior: 'smooth', block: 'center' });

            const isShort = title.toLowerCase().includes('#shorts');
            $('#playerContainer').classList.toggle('is-short', isShort);
            
            const playerOptions = {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                events: {
                    'onReady': () => { /* 未來可用 */ },
                    'onStateChange': () => { /* 未來可用 */ }
                }
            };

            if (type === 'playlist') {
                playerOptions.playerVars.listType = 'playlist';
                playerOptions.playerVars.list = id;
            } else {
                playerOptions.videoId = id;
            }

            if (player) {
                if (type === 'video') player.loadVideoById(id);
                else player.loadPlaylist({ list: id, listType: 'playlist' });
            } else {
                player = new YT.Player('youtube-player', playerOptions);
            }
        }

        function toggleFullScreen() {
            const playerIframe = $('#youtube-player');
            if (!playerIframe || !player) return; // 確保播放器存在

            if (document.fullscreenElement || document.webkitFullscreenElement) {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            } else {
                const playerElement = player.getIframe();
                if (playerElement.requestFullscreen) playerElement.requestFullscreen();
                else if (playerElement.webkitRequestFullscreen) playerElement.webkitRequestFullscreen();
            }
        }

        function copyVideoUrl() {
            if (!currentVideoId) {
                alert('目前播放的不是單一影片，無法複製網址。');
                return;
            }
            const url = `https://www.youtube.com/watch?v=${currentVideoId}`;
            navigator.clipboard.writeText(url).then(() => {
                const btn = $('#copyUrlBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '✅ 已複製!';
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            }).catch(err => { alert('複製失敗: ', err); });
        }
    </script>
</body>
</html>
